name: valgrind

concurrency:
  group: ${{ github.repository }}-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:

jobs:
  valgrind:
    runs-on: ubuntu-latest

    env:
      regression-artifact-name: Surelog_regression_ubuntu-gcc_debug_${{ github.run_number }}

    steps:
    - name: Install Core Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          g++-11                \
          default-jre           \
          cmake                 \
          build-essential       \
          uuid-dev              \
          ninja-build           \
          valgrind              \
          google-perftools      \
          libgoogle-perftools-dev

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON3_VERSION }}
        architecture: 'x64'

    - name: Setup Python Packages
      run: pip3 install orderedmultidict psutil build

    - name: Git Pull
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build on Linux
      shell: bash
      env:
        CC: gcc-11
        CXX: g++-11
      run: |
        env
        which cmake && cmake --version
        which java && java -version
        which python && python --version
        which ninja && ninja --version
        which $CC && $CC --version
        which $CXX && $CXX --version

        cmake -G Ninja                        \
          -DCMAKE_BUILD_TYPE=Debug            \
          -DPython3_ROOT_DIR=$pythonLocation  \
          -DWITH_STATIC_CRT=0                 \
          -DCMAKE_INSTALL_PREFIX=install      \
          -S . -B build

        cmake --build build -j `nproc`
        cmake --install build
          
    - name: Run valgrind regression tests
      run: python3 scripts/regression.py run --tool valgrind --filters ArianeElab

    - name: Prepare regression artifacts
      if: always()
      run: |
        ls -l build
        cd build
        ls -l regression
        mv regression ${{ env.regression-artifact-name }}
        find ${{ env.regression-artifact-name }} -name "*.tar.gz" | tar czfp ${{ env.regression-artifact-name }}.tar.gz -T -

    - name: Archive artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.regression-artifact-name }}
        path: build/${{ env.regression-artifact-name }}.tar.gz



#         cd $GITHUB_WORKSPACE/tests
#         for test in $(find . -type f -executable -name "*test*"); do
#           valgrind --leak-check=full \
#             --show-leak-kinds=all \
#             --track-origins=yes \
#             --verbose \
#             --log-file=valgrind_report_$(basename $test).txt \
#             ./$test
#         done
          
#     - name: Upload Valgrind reports
#       if: always()
#       uses: actions/upload-artifact@v4
#       with:
#         name: valgrind-reports
#         path: tests/valgrind_report_*.txt
#           
#     - name: Check for memory leaks
#       run: |
#         if grep -l "ERROR SUMMARY: [1-9]" tests/valgrind_report_*.txt 2>/dev/null; then
#           echo "Memory leaks detected!"
#           exit 1
#         fi
