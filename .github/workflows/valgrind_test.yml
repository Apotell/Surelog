name: Valgrind Test

on:
    - push
    - pull_request
    - workflow_dispatch
jobs:
    valgrind:
        runs-on: ubuntu-latest
        
        steps:
          - uses: actions/checkout@v4
            with:
              submodules: recursive
          
          - name: Install dependencies
            run: |
              sudo apt-get update
              sudo apt-get install -y valgrind
          
          - name: Build on Linux
            if: runner.os == 'Linux'
            shell: bash
            env:
             CC: gcc-11
             CXX: g++-11
            run: |
              env
              which cmake && cmake --version
              which java && java -version
              which python && python --version
              which ninja && ninja --version
              which $CC && $CC --version
              which $CXX && $CXX --version

              if [[ "${{ matrix.config.build-type }}" == "debug" ]]; then
                cmake -G Ninja                        \
              -DCMAKE_BUILD_TYPE=Debug            \
              -DPython3_ROOT_DIR=$pythonLocation  \
              -DWITH_STATIC_CRT=0                 \
              -DCMAKE_INSTALL_PREFIX=out/install  \
              -S . -B out/build
              else
                cmake -G Ninja                        \
              -DCMAKE_BUILD_TYPE=RelWithDebInfo   \
              -DPython3_ROOT_DIR=$pythonLocation  \
              -DWITH_STATIC_CRT=0                 \
              -DCMAKE_INSTALL_PREFIX=out/install  \
              -S . -B out/build
              fi

              cmake --build out/build -j `nproc`
              cmake --install out/build
          
          - name: Run Valgrind tests
            run: |
              cd $GITHUB_WORKSPACE/tests
              for test in $(find . -type f -executable -name "*test*"); do
                valgrind --leak-check=full \
                  --show-leak-kinds=all \
                  --track-origins=yes \
                  --verbose \
                  --log-file=valgrind_report_$(basename $test).txt \
                  ./$test
              done
          
          - name: Upload Valgrind reports
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: valgrind-reports
              path: tests/valgrind_report_*.txt
          
          - name: Check for memory leaks
            run: |
              if grep -l "ERROR SUMMARY: [1-9]" tests/valgrind_report_*.txt 2>/dev/null; then
                echo "Memory leaks detected!"
                exit 1
              fi